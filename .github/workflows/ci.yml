name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get update -qq && sudo apt-get install -y shellcheck

      - name: Shellcheck
        run: shellcheck install.sh verify.sh

      - name: Dry-run install plan (no changes)
        run: bash install.sh --plan

      - name: Verify SHA256SUMS is up-to-date
        run: |
          bash scripts/update_checksums.sh
          git diff --exit-code SHA256SUMS || {
            echo "::error file=SHA256SUMS::SHA256SUMS is out of sync. Please run 'bash scripts/update_checksums.sh' and commit the changes."
            exit 1
          }

  nix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27

      - name: nix flake check
        run: nix flake check

  docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build toolbox image
        run: docker build -t srps-ci .

  go:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Go test
        run: go test ./...

      - name: Go build (sysmon)
        run: go build ./cmd/sysmon
